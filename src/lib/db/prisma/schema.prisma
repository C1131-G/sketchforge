generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum BoardVisibility {
  PRIVATE
  LINK
  PUBLIC
}

enum ShapeType {
  RECTANGLE
  ELLIPSE
  TEXT
  ARROW
  IMAGE
  STROKE_REF
}

enum RoleType {
  OWNER
  EDITOR
  VIEWER
}

enum SnapshotKind {
  AUTO
  MANUAL
}

model User {
  id             String   @id @default(cuid())
  name           String
  email          String   @unique
  hashedPassword String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deletedAt DateTime?

  boards      Board[]       @relation("UserBoards")
  shapes      Shape[]
  strokes     Stroke[]
  memberships BoardMember[]
  snapshots   Snapshot[]

  @@index([deletedAt])
}

model Board {
  id      String @id @default(cuid())
  title   String

  ownerId String
  owner   User   @relation("UserBoards", fields: [ownerId], references: [id], onDelete: Cascade)

  visibility BoardVisibility @default(PRIVATE)

  metadata Json @default("{}")

  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  layers     Layer[]
  shapes     Shape[]
  strokes    Stroke[]
  snapshots  Snapshot[]
  members    BoardMember[]

  @@index([ownerId, deletedAt])
  @@index([visibility, deletedAt])
  @@index([deletedAt])
}

model Layer {
  id      String @id @default(cuid())

  boardId String
  board   Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)

  name     String
  zIndex   Int
  isLocked Boolean @default(false)
  isVisible Boolean @default(true)

  deletedAt DateTime?

  shapes Shape[]
  strokes Stroke[]

  @@index([boardId, zIndex])
  @@index([boardId, deletedAt])
}

model Shape {
  id String @id @default(cuid())

  boardId String
  board   Board @relation(fields: [boardId], references: [id], onDelete: Cascade)

  layerId String
  layer   Layer @relation(fields: [layerId], references: [id], onDelete: Cascade)

  type ShapeType
  dataJson Json
  styleJson Json

  ownerId String
  owner   User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  zIndex    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deletedAt DateTime?

  @@index([boardId, layerId, deletedAt])
  @@index([layerId, deletedAt])
  @@index([boardId, zIndex])
  @@index([ownerId, deletedAt])
  @@index([deletedAt])
}

model Stroke {
  id String @id @default(cuid())

  boardId String
  board   Board @relation(fields: [boardId], references: [id], onDelete: Cascade)

  layerId String
  layer   Layer @relation(fields: [layerId], references: [id], onDelete: Cascade)

  pointsBlob   Bytes
  penPropsJson Json

  ownerId String
  owner   User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([boardId])
  @@index([layerId])
  @@index([ownerId])
}

model BoardMember {
  id String @id @default(cuid())

  boardId String
  board   Board @relation(fields: [boardId], references: [id], onDelete: Cascade)

  userId String
  user   User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  role RoleType @default(EDITOR)

  inviteToken String? @unique
  acceptedAt DateTime?

  createdAt DateTime @default(now())

  @@index([boardId])
  @@index([userId])
  @@unique([boardId, userId])
}

model Snapshot {
  id String @id @default(cuid())

  boardId String
  board   Board @relation(fields: [boardId], references: [id], onDelete: Cascade)

  snapshotJson Json

  createdBy String
  creator   User @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt

  kind SnapshotKind

  createdAt DateTime @default(now())

  @@index([boardId])
  @@index([createdBy])
}

